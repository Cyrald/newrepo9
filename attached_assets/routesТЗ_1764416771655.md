# –ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ä–æ—É—Ç–æ–≤ –∏ –ø–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–æ–∫

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 29 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** Modular Routes Architecture (November 2025)  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ –¥–ª—è production

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ](#1-—Ç–µ–∫—É—â–µ–µ-—Å–æ—Å—Ç–æ—è–Ω–∏–µ)
2. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã](#2-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏](#3-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏)
4. [–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å](#4-–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
5. [–ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞](#5-–ø—Ä–æ–±–ª–µ–º—ã-–∫–∞—á–µ—Å—Ç–≤–∞-–∫–æ–¥–∞)
6. [–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π](#6-–ø–ª–∞–Ω-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#7-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)

---

## 1. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### 1.1 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**–î–æ:**
- `server/routes.old.ts`: **1862 —Å—Ç—Ä–æ–∫–∏**, **61 endpoint**
- –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–ª–æ–∂–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–ü–æ—Å–ª–µ:**
- **12 –º–æ–¥—É–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: **1449 —Å—Ç—Ä–æ–∫** (—ç–∫–æ–Ω–æ–º–∏—è 22%)
- **61 endpoint** - –≤—Å–µ endpoints –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º

### 1.2 –°–æ–∑–¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

| –§–∞–π–ª | Endpoints | –°—Ç—Ä–æ–∫–∏ | –°—Ç–∞—Ç—É—Å |
|------|-----------|--------|--------|
| `health.routes.ts` | 2 | 16 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `auth.routes.ts` | 7 | 187 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `products.routes.ts` | 9 | 248 | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| `cart.routes.ts` | 5 | 93 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `wishlist.routes.ts` | 3 | 52 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `addresses.routes.ts` | 5 | 78 | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| `payment-cards.routes.ts` | 4 | 50 | ‚ö†Ô∏è –ù—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è + —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| `categories.routes.ts` | 5 | 86 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `promocodes.routes.ts` | 5 | 79 | ‚ö†Ô∏è Race condition |
| `orders.routes.ts` | 4 | 316 | ‚ö†Ô∏è Race condition + –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| `admin.routes.ts` | 2 | 55 | ‚ùå –ù–µ–ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª |
| `support.routes.ts` | 10 | 193 | ‚ùå LSP –æ—à–∏–±–∫–∏ |
| **–ò–¢–û–ì–û** | **61** | **1449** | - |

### 1.3 –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

‚úÖ **–•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
1. WebSocket notifications –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ `orders.routes.ts` (—Å–æ–∑–¥–∞–Ω–∏–µ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
2. WebSocket notifications —Ä–∞–±–æ—Ç–∞—é—Ç –≤ `support.routes.ts`
3. IDOR –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `addresses.routes.ts` –∏ `payment-cards.routes.ts`
4. –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript –∏ typed connectedUsers
6. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π logger –¥–ª—è –æ—à–∏–±–æ–∫

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—á–∞—Å—Ç–∏—á–Ω–æ):**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ addresses –∏ payment-cards
- Rate limiting –ø—Ä–∏–º–µ–Ω—ë–Ω
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ middleware

---

## 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 2.1 LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts

**–§–∞–π–ª:** `server/routes/support.routes.ts`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫)

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### –û—à–∏–±–∫–∞ 1: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `getSupportConversation`
```typescript
// –°—Ç—Ä–æ–∫–∞ 149
const conversation = await storage.getSupportConversation(req.userId!);
//                                   ^^^^^^^^^^^^^^^^^^^^^^^^
// Error: Property 'getSupportConversation' does not exist on type 'DatabaseStorage'
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/storage.ts
async getSupportConversation(userId: string): Promise<SupportConversation | undefined> {
  const [conversation] = await db
    .select()
    .from(supportConversations)
    .where(eq(supportConversations.userId, userId))
    .limit(1);
  return conversation;
}
```

#### –û—à–∏–±–∫–∞ 2: –ù–µ–≤–µ—Ä–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `searchClosedConversations`
```typescript
// –°—Ç—Ä–æ–∫–∞ 155
const closedConversations = await storage.searchClosedConversations(query);
//                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
// Error: Type 'string' has no properties in common with type '{ email?: string; ... }'
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/routes/support.routes.ts
router.get("/closed-search", authenticateToken, requireRole("admin", "consultant"), async (req, res) => {
  const query = req.query.q as string;
  
  // –ü–µ—Ä–µ–¥–∞—Ç—å –∫–∞–∫ –æ–±—ä–µ–∫—Ç
  const closedConversations = await storage.searchClosedConversations({
    email: query,
  });
  
  res.json(closedConversations);
});
```

#### –û—à–∏–±–∫–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `createSupportMessageAttachment`
```typescript
// –°—Ç—Ä–æ–∫–∞ 176
const attachment = await storage.createSupportMessageAttachment({
//                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
// Error: Property 'createSupportMessageAttachment' does not exist
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/storage.ts
async createSupportMessageAttachment(
  attachment: InsertSupportMessageAttachment
): Promise<SupportMessageAttachment> {
  const [newAttachment] = await db
    .insert(supportMessageAttachments)
    .values(attachment)
    .returning();
  return newAttachment;
}
```

---

### 2.2 Promocode Race Condition

**–§–∞–π–ª:** `server/routes/orders.routes.ts:66-76`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–í–ù–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**, –∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ **–í–ù–£–¢–†–ò**:

```typescript
// –í–ù–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è race condition
if (data.promocodeId) {
  const promocodeValidation = await validatePromocode(
    data.promocodeId,
    req.userId!,
    subtotal
  );
  // ... –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ
}

// –í–ù–£–¢–†–ò —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–æ–∑–∂–µ)
const order = await db.transaction(async (tx) => {
  // –ü—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
  if (promocodeId) {
    // ...
  }
});
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ò—Å—Ç—ë–∫—à–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω—ë–Ω
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏

**–†–µ—à–µ–Ω–∏–µ:**
–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –í–°–Æ –ª–æ–≥–∏–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–∞ –í–ù–£–¢–†–¨ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å pessimistic locking:

```typescript
router.post("/", authenticateToken, orderLimiter, async (req, res) => {
  try {
    const data = createOrderSchema.parse(req.body);
    const user = await storage.getUser(req.userId!);

    if (!user) {
      return res.status(404).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }

    // –í—ã—á–∏—Å–ª–∏—Ç—å subtotal –î–û —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ë–î)
    let subtotal = 0;
    for (const item of data.items) {
      const price = parseFloat(item.price);
      subtotal += price * item.quantity;
    }

    const bonusesUsed = data.bonusesUsed || 0;

    if (data.promocodeId && bonusesUsed > 0) {
      return res.status(400).json({ 
        message: "–ù–µ–ª—å–∑—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –±–æ–Ω—É—Å—ã." 
      });
    }

    // –ü–ï–†–ï–ú–ï–°–¢–ò–¢–¨ –≤—Å—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–∞ –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    const order = await db.transaction(async (tx) => {
      // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      let discountAmount = 0;
      let promocodeId = null;
      
      if (data.promocodeId) {
        // –ë–õ–û–ö–ò–†–û–í–ê–¢–¨ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const [promocode] = await tx
          .select()
          .from(promocodes)
          .where(and(
            eq(promocodes.id, data.promocodeId),
            eq(promocodes.isActive, true)
          ))
          .for('update') // Pessimistic lock
          .limit(1);
        
        if (!promocode) {
          throw new Error('PROMOCODE_NOT_FOUND');
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –í–ù–£–¢–†–ò —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        if (promocode.expiresAt && new Date(promocode.expiresAt) < new Date()) {
          throw new Error('PROMOCODE_EXPIRED');
        }
        
        if (promocode.minOrderAmount && parseFloat(promocode.minOrderAmount) > subtotal) {
          throw new Error(`PROMOCODE_MIN_AMOUNT:${promocode.minOrderAmount}`);
        }
        
        if (promocode.maxOrderAmount && parseFloat(promocode.maxOrderAmount) < subtotal) {
          throw new Error(`PROMOCODE_MAX_AMOUNT:${promocode.maxOrderAmount}`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è temporary –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        if (promocode.type === 'temporary') {
          const [existing] = await tx
            .select()
            .from(promocodeUsage)
            .where(and(
              eq(promocodeUsage.promocodeId, data.promocodeId),
              eq(promocodeUsage.userId, req.userId!)
            ))
            .limit(1);
          
          if (existing) {
            throw new Error('PROMOCODE_ALREADY_USED');
          }
        }
        
        // –í—ã—á–∏—Å–ª–∏—Ç—å —Å–∫–∏–¥–∫—É
        discountAmount = (subtotal * parseFloat(promocode.discountPercent)) / 100;
        
        if (promocode.maxDiscountAmount && discountAmount > parseFloat(promocode.maxDiscountAmount)) {
          discountAmount = parseFloat(promocode.maxDiscountAmount);
        }
        
        promocodeId = promocode.id;
      }
      
      // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–Ω—É—Å–æ–≤
      const subtotalAfterPromocode = subtotal - discountAmount;
      const { maxUsable } = canUseBonuses(user.bonusBalance, subtotalAfterPromocode);
      
      if (bonusesUsed > maxUsable) {
        throw new Error(`INSUFFICIENT_BONUS:${maxUsable}`);
      }
      
      // 3. –í—ã—á–∏—Å–ª–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—É–º–º—É
      const subtotalAfterBonuses = subtotalAfterPromocode - bonusesUsed;
      const deliveryCost = 300;
      const total = subtotalAfterBonuses + deliveryCost;
      
      const bonusesEarned = calculateCashback(
        total,
        bonusesUsed > 0,
        discountAmount > 0
      );
      
      // 4. –°–ø–∏—Å–∞—Ç—å stock (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
      for (const item of data.items) {
        const updateResult = await tx.execute(
          sql`UPDATE products 
              SET stock_quantity = stock_quantity - ${item.quantity},
                  updated_at = NOW()
              WHERE id = ${item.productId}
                AND stock_quantity >= ${item.quantity}
              RETURNING id, name, stock_quantity`
        );
        
        if (!updateResult.rows || updateResult.rows.length === 0) {
          const checkProduct = await tx.execute(
            sql`SELECT id, name, stock_quantity FROM products WHERE id = ${item.productId}`
          );
          if (!checkProduct.rows || checkProduct.rows.length === 0) {
            throw new Error(`PRODUCT_NOT_FOUND:${item.productId}`);
          }
          const product = checkProduct.rows[0] as any;
          throw new Error(`INSUFFICIENT_STOCK:${product.name}:${product.stock_quantity}:${item.quantity}`);
        }
      }
      
      // 5. –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
      if (bonusesUsed > 0) {
        const bonusResult = await tx.execute(
          sql`UPDATE users 
              SET bonus_balance = bonus_balance - ${bonusesUsed},
                  updated_at = NOW()
              WHERE id = ${req.userId}
                AND bonus_balance >= ${bonusesUsed}
              RETURNING id`
        );
        
        if (!bonusResult.rows || bonusResult.rows.length === 0) {
          throw new Error('INSUFFICIENT_BONUS');
        }
      }
      
      // 6. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
      const orderNumber = `ORD-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`;
      
      const [createdOrder] = await tx
        .insert(orders)
        .values({
          userId: req.userId!,
          orderNumber,
          status: "pending",
          items: data.items as any,
          subtotal: subtotal.toString(),
          discountAmount: discountAmount.toString(),
          bonusesUsed: bonusesUsed.toString(),
          bonusesEarned: bonusesEarned.toString(),
          promocodeId,
          deliveryService: data.deliveryService,
          deliveryType: data.deliveryType,
          deliveryPointCode: data.deliveryPointCode || null,
          deliveryAddress: data.deliveryAddress as any,
          deliveryCost: deliveryCost.toString(),
          deliveryTrackingNumber: null,
          paymentMethod: data.paymentMethod,
          paymentStatus: "pending",
          yukassaPaymentId: null,
          total: total.toString(),
        })
        .returning();
      
      // 7. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
      if (promocodeId) {
        const [promocode] = await tx
          .select()
          .from(promocodes)
          .where(eq(promocodes.id, promocodeId))
          .limit(1);
        
        if (promocode) {
          if (promocode.type === "single_use") {
            await tx.delete(promocodes).where(eq(promocodes.id, promocodeId));
          } else if (promocode.type === "temporary") {
            await tx.insert(promocodeUsage).values({
              promocodeId,
              userId: req.userId!,
              orderId: createdOrder.id,
            });
          }
        }
      }
      
      // 8. –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
      await tx.delete(cartItems).where(eq(cartItems.userId, req.userId!));
      
      return createdOrder;
    });
    
    // WebSocket notifications (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
    // ...
    
    res.json(order);
  } catch (error: any) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    
    if (error.message === 'PROMOCODE_NOT_FOUND') {
      return res.status(404).json({ message: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω" });
    }
    
    if (error.message === 'PROMOCODE_EXPIRED') {
      return res.status(400).json({ message: "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫" });
    }
    
    if (error.message?.startsWith('PROMOCODE_MIN_AMOUNT:')) {
      const minAmount = error.message.split(':')[1];
      return res.status(400).json({ 
        message: `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: ${minAmount}‚ÇΩ` 
      });
    }
    
    if (error.message?.startsWith('PROMOCODE_MAX_AMOUNT:')) {
      const maxAmount = error.message.split(':')[1];
      return res.status(400).json({ 
        message: `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: ${maxAmount}‚ÇΩ` 
      });
    }
    
    if (error.message === 'PROMOCODE_ALREADY_USED') {
      return res.status(400).json({ message: "–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥" });
    }
    
    if (error.message?.startsWith('INSUFFICIENT_BONUS:')) {
      const maxUsable = error.message.split(':')[1];
      return res.status(400).json({ 
        message: `–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞–∫—Å–∏–º—É–º ${maxUsable} –±–æ–Ω—É—Å–æ–≤` 
      });
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    
    logger.error('Order creation error', { error, userId: req.userId });
    res.status(500).json({ message: "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞" });
  }
});
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ù–ï–ú–ï–î–õ–ï–ù–ù–û, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø–æ—Ç–µ—Ä—è–º.

---

### 2.3 SQL Injection –≤ WebSocket validation

**–§–∞–π–ª:** `server/routes.ts:65`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const result = await db.execute(sql`SELECT sess FROM session WHERE sid = ${sid}`);
```

–•–æ—Ç—è –µ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ regex, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ raw SQL –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/routes.ts
async function validateSessionFromCookie(cookieHeader: string | undefined) {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ cookie ...
  
  const sid = unsignedValue;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
  if (!SESSION_ID_REGEX.test(sid)) {
    logger.warn('Invalid session ID format detected', { 
      sid: sid.substring(0, 10) + '...' 
    });
    return null;
  }
  
  try {
    // –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ Drizzle ORM –≤–º–µ—Å—Ç–æ raw SQL
    const [session] = await db
      .select()
      .from(sessions) // –ù—É–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É sessions
      .where(eq(sessions.sid, sid))
      .limit(1);
    
    if (!session || !session.sess?.userId) return null;
    
    return {
      userId: session.sess.userId,
      userRoles: session.sess.userRoles || []
    };
  } catch (error) {
    logger.error('Session validation error', { error });
    return null;
  }
}
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –¥–ª—è sessions table:
```typescript
// shared/schema.ts
export const sessions = pgTable("session", {
  sid: varchar("sid").primaryKey(),
  sess: jsonb("sess").notNull(),
  expire: timestamp("expire").notNull(),
});
```

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

### 3.1 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Zod –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–§–∞–π–ª—ã:** `addresses.routes.ts`, `payment-cards.routes.ts`, `products.routes.ts` (—á–∞—Å—Ç–∏—á–Ω–æ)  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–æ—É—Ç–æ–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Zod —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:

```typescript
// addresses.routes.ts:12-29 - –ù–ï–¢ –≤–∞–ª–∏–¥–∞—Ü–∏–∏!
router.post("/", authenticateToken, async (req, res) => {
  const address = await storage.createUserAddress({
    userId: req.userId!,
    label: req.body.label || "–î–æ–º", // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º
    fullAddress: req.body.fullAddress, // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
    city: req.body.city, // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
    street: req.body.street, // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
    building: req.body.building, // –ú–æ–∂–µ—Ç –±—ã—Ç—å NULL –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
    apartment: req.body.apartment || null,
    postalCode: req.body.postalCode, // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç
    isDefault: req.body.isDefault || false,
  });
  // ...
});
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
- –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
- –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å Zod —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö endpoints:

```typescript
// shared/schema.ts
export const createAddressSchema = z.object({
  label: z.string()
    .min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(100, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9\s]+$/, "–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ–±–µ–ª—ã"),
  
  fullAddress: z.string()
    .min(10, "–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
    .max(500, "–ê–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  city: z.string()
    .min(2, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(100, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Å\s-]+$/, "–¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã"),
  
  street: z.string()
    .min(2, "–ù–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(200, "–ù–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"),
  
  building: z.string()
    .min(1, "–ù–æ–º–µ—Ä –¥–æ–º–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(20, "–ù–æ–º–µ—Ä –¥–æ–º–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  apartment: z.string()
    .max(20, "–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .optional(),
  
  postalCode: z.string()
    .regex(/^\d{6}$/, "–ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä"),
  
  isDefault: z.boolean().optional().default(false),
});

export const updateAddressSchema = createAddressSchema.partial();

export const createPaymentCardSchema = z.object({
  yukassaPaymentToken: z.string()
    .min(1, "–¢–æ–∫–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(500, "–¢–æ–∫–µ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  cardLastFour: z.string()
    .regex(/^\d{4}$/, "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏"),
  
  cardType: z.enum(["visa", "mastercard", "mir", "other"], {
    errorMap: () => ({ message: "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–∞—Ä—Ç—ã" })
  }),
  
  isDefault: z.boolean().optional().default(false),
});

// server/routes/addresses.routes.ts
import { createAddressSchema, updateAddressSchema } from '@shared/schema';

router.post("/", authenticateToken, async (req, res) => {
  try {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod
    const data = createAddressSchema.parse(req.body);
    
    const address = await storage.createUserAddress({
      ...data,
      userId: req.userId!,
    });

    if (data.isDefault) {
      await storage.setDefaultAddress(req.userId!, address.id);
    }

    res.json(address);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ 
        message: error.errors[0].message,
        errors: error.errors 
      });
    }
    throw error;
  }
});

router.put("/:id", authenticateToken, async (req, res) => {
  try {
    const existingAddress = await storage.getUserAddress(req.params.id);
    
    if (!existingAddress) {
      return res.status(404).json({ message: "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }
    
    if (existingAddress.userId !== req.userId) {
      return res.status(403).json({ message: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É" });
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod
    const data = updateAddressSchema.parse(req.body);

    const updated = await storage.updateUserAddress(req.params.id, data);

    res.json(updated);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ 
        message: error.errors[0].message,
        errors: error.errors 
      });
    }
    throw error;
  }
});

// server/routes/payment-cards.routes.ts
import { createPaymentCardSchema } from '@shared/schema';

router.post("/", authenticateToken, async (req, res) => {
  try {
    const data = createPaymentCardSchema.parse(req.body);
    
    const card = await storage.createUserPaymentCard({
      ...data,
      userId: req.userId!,
    });

    if (data.isDefault) {
      await storage.setDefaultPaymentCard(req.userId!, card.id);
    }

    res.json(card);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ 
        message: error.errors[0].message,
        errors: error.errors 
      });
    }
    throw error;
  }
});
```

---

### 3.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞

**–§–∞–π–ª—ã:** `addresses.routes.ts`, `payment-cards.routes.ts`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü† –°–†–ï–î–ù–Ø–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:

```typescript
// addresses.routes.ts:32-41
const existingAddress = await storage.getUserAddress(req.params.id);

if (!existingAddress) {
  return res.status(404).json({ message: "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
}

if (existingAddress.userId !== req.userId) {
  return res.status(403).json({ message: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É" });
}

// payment-cards.routes.ts:40-44
const card = await storage.getUserPaymentCard(req.params.id);

if (!card || card.userId !== req.userId) {
  return res.status(403).json({ message: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–∞—Ä—Ç–µ" });
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å reusable middleware:

```typescript
// server/middleware/resourceOwnership.ts
import { Request, Response, NextFunction } from 'express';
import { storage } from '../storage';
import { logger } from '../utils/logger';

interface ResourceWithOwner {
  userId: string;
  [key: string]: any;
}

/**
 * Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–º
 * @param resourceGetter - –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞ –ø–æ ID
 * @param resourceName - –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
 */
export function requireOwnership(
  resourceGetter: (id: string) => Promise<ResourceWithOwner | undefined>,
  resourceName: string
) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const resource = await resourceGetter(req.params.id);
      
      if (!resource) {
        return res.status(404).json({ 
          message: `${resourceName} –Ω–µ ${resourceName.endsWith('–∞') ? '–Ω–∞–π–¥–µ–Ω–∞' : '–Ω–∞–π–¥–µ–Ω'}` 
        });
      }
      
      if (resource.userId !== (req as any).userId) {
        logger.warn('IDOR attempt detected', {
          userId: (req as any).userId,
          resourceId: req.params.id,
          resourceType: resourceName,
          actualOwner: resource.userId,
          ip: req.ip,
          userAgent: req.get('user-agent'),
        });
        return res.status(403).json({ message: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω" });
      }
      
      // –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ä–µ—Å—É—Ä—Å –∫ request –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handler
      (req as any).resource = resource;
      
      next();
    } catch (error) {
      logger.error('Resource ownership check error', { error, resourceName });
      res.status(500).json({ message: "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞" });
    }
  };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
// server/routes/addresses.routes.ts
import { requireOwnership } from '../middleware/resourceOwnership';

router.put(
  "/:id",
  authenticateToken,
  requireOwnership(storage.getUserAddress.bind(storage), '–ê–¥—Ä–µ—Å'),
  async (req, res) => {
    try {
      const data = updateAddressSchema.parse(req.body);
      
      // –†–µ—Å—É—Ä—Å —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω middleware
      const updated = await storage.updateUserAddress(req.params.id, data);
      res.json(updated);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          message: error.errors[0].message 
        });
      }
      throw error;
    }
  }
);

router.delete(
  "/:id",
  authenticateToken,
  requireOwnership(storage.getUserAddress.bind(storage), '–ê–¥—Ä–µ—Å'),
  async (req, res) => {
    await storage.deleteUserAddress(req.params.id);
    res.json({ message: "–ê–¥—Ä–µ—Å —É–¥–∞–ª—ë–Ω" });
  }
);

// server/routes/payment-cards.routes.ts
router.delete(
  "/:id",
  authenticateToken,
  requireOwnership(storage.getUserPaymentCard.bind(storage), '–ö–∞—Ä—Ç–∞'),
  async (req, res) => {
    await storage.deleteUserPaymentCard(req.params.id);
    res.json({ message: "–ö–∞—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞" });
  }
);
```

---

### 3.3 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–§–∞–π–ª—ã:** –í—Å–µ route —Ñ–∞–π–ª—ã  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü† –°–†–ï–î–ù–Ø–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ö–∞–∂–¥—ã–π route handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é:

```typescript
// orders.routes.ts:227-254
catch (error: any) {
  if (error instanceof z.ZodError) {
    return res.status(400).json({ message: error.errors[0].message });
  }
  
  if (error.message?.startsWith('PRODUCT_NOT_FOUND:')) {
    // ...
  }
  
  if (error.message?.startsWith('INSUFFICIENT_STOCK:')) {
    // ...
  }
  
  // ... 10+ –ø—Ä–æ–≤–µ—Ä–æ–∫
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `errorHandler` middleware –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ error –∫–ª–∞—Å—Å—ã:

```typescript
// server/utils/errors.ts (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
export class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public code?: string
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export class ProductNotFoundError extends AppError {
  constructor(productId: string) {
    super(404, `–¢–æ–≤–∞—Ä ${productId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'PRODUCT_NOT_FOUND');
  }
}

export class InsufficientStockError extends AppError {
  constructor(productName: string, available: number, requested: number) {
    super(
      400, 
      `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ "${productName}". –î–æ—Å—Ç—É–ø–Ω–æ: ${available}, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: ${requested}`,
      'INSUFFICIENT_STOCK'
    );
  }
}

export class PromocodeError extends AppError {
  constructor(message: string, code: string) {
    super(400, message, code);
  }
}

// server/routes/orders.routes.ts
import { 
  ProductNotFoundError, 
  InsufficientStockError, 
  PromocodeError 
} from '../utils/errors';

router.post("/", authenticateToken, orderLimiter, async (req, res, next) => {
  try {
    // ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
    
    // –í–º–µ—Å—Ç–æ throw new Error('PRODUCT_NOT_FOUND:...')
    throw new ProductNotFoundError(item.productId);
    
    // –í–º–µ—Å—Ç–æ throw new Error('INSUFFICIENT_STOCK:...')
    throw new InsufficientStockError(product.name, product.stock_quantity, item.quantity);
    
    // –í–º–µ—Å—Ç–æ throw new Error('PROMOCODE_ALREADY_USED')
    throw new PromocodeError('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥', 'PROMOCODE_ALREADY_USED');
    
    res.json(order);
  } catch (error) {
    // –ü–µ—Ä–µ–¥–∞—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π errorHandler
    next(error);
  }
});

// server/middleware/errorHandler.ts (—É–ª—É—á—à–µ–Ω–Ω—ã–π)
import { Request, Response, NextFunction } from 'express';
import { AppError } from '../utils/errors';
import { ZodError } from 'zod';
import { logger } from '../utils/logger';

export function errorHandler(
  error: any,
  req: Request,
  res: Response,
  next: NextFunction
): void {
  // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  logger.error('Request error', {
    name: error.name,
    message: error.message,
    code: error.code,
    stack: error.stack,
    path: req.path,
    method: req.method,
    userId: (req as any).userId,
    ip: req.ip,
    userAgent: req.get('user-agent'),
  });

  // AppError - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  if (error instanceof AppError) {
    return res.status(error.statusCode).json({
      success: false,
      error: {
        message: error.message,
        code: error.code,
      },
    });
  }

  // Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è
  if (error instanceof ZodError) {
    return res.status(400).json({
      success: false,
      error: {
        message: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö',
        code: 'VALIDATION_ERROR',
        details: process.env.NODE_ENV === 'development' ? error.errors : undefined,
      },
    });
  }

  // –û—à–∏–±–∫–∏ –ë–î
  if (error.code === '23505') {
    return res.status(409).json({
      success: false,
      error: {
        message: '–ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
        code: 'DUPLICATE_ERROR',
      },
    });
  }

  if (error.code === '23503') {
    return res.status(400).json({
      success: false,
      error: {
        message: '–°–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
        code: 'FOREIGN_KEY_ERROR',
      },
    });
  }

  // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
  res.status(500).json({
    success: false,
    error: {
      message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
      code: 'INTERNAL_SERVER_ERROR',
    },
  });
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ server/index.ts
import { errorHandler } from './middleware/errorHandler';

// –ü–æ—Å–ª–µ –≤—Å–µ—Ö —Ä–æ—É—Ç–æ–≤
app.use(errorHandler);
```

---

## 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 4.1 –ù–µ–ø–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å admin.routes.ts

**–§–∞–π–ª:** `server/routes/admin.routes.ts`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º `routes.old.ts` –±—ã–ª–æ –±–æ–ª—å—à–µ admin endpoints:

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ)
2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (CRUD)
4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ (CRUD)
5. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ –ø–µ—Ä–∏–æ–¥–∞–º, –≥—Ä–∞—Ñ–∏–∫–∏)
6. –ê—É–¥–∏—Ç –ª–æ–≥–∏

**–¢–µ–∫—É—â–∏–µ endpoints:**
- `GET /api/admin/stats` - –±–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /api/admin/users` - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ endpoints:

```typescript
// server/routes/admin.routes.ts
import { Router } from "express";
import { storage } from "../storage";
import { db } from "../db";
import { authenticateToken, requireRole } from "../auth";
import { sql, and, gte, lte } from "drizzle-orm";
import { z } from "zod";
import { logger } from "../utils/logger";

const router = Router();

// ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========

router.get("/stats", authenticateToken, requireRole("admin"), async (req, res) => {
  const [
    totalUsersResult,
    totalProductsResult,
    totalOrdersResult,
    totalRevenueResult,
    pendingOrdersResult,
    activePromocodesResult,
  ] = await Promise.all([
    db.execute(sql`SELECT COUNT(*)::int as count FROM users`),
    db.execute(sql`SELECT COUNT(*)::int as count FROM products WHERE is_archived = false`),
    db.execute(sql`SELECT COUNT(*)::int as count FROM orders`),
    db.execute(sql`SELECT COALESCE(SUM(CAST(total AS DECIMAL)), 0) as total FROM orders WHERE payment_status = 'paid'`),
    db.execute(sql`SELECT COUNT(*)::int as count FROM orders WHERE status = 'pending'`),
    db.execute(sql`SELECT COUNT(*)::int as count FROM promocodes WHERE is_active = true`),
  ]);

  res.json({
    totalUsers: totalUsersResult.rows?.[0]?.count || 0,
    totalProducts: totalProductsResult.rows?.[0]?.count || 0,
    totalOrders: totalOrdersResult.rows?.[0]?.count || 0,
    totalRevenue: parseFloat(totalRevenueResult.rows?.[0]?.total as string || '0'),
    pendingOrders: pendingOrdersResult.rows?.[0]?.count || 0,
    activePromocodes: activePromocodesResult.rows?.[0]?.count || 0,
  });
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
const statsQuerySchema = z.object({
  startDate: z.string().optional(),
  endDate: z.string().optional(),
});

router.get("/stats/period", authenticateToken, requireRole("admin"), async (req, res) => {
  try {
    const { startDate, endDate } = statsQuerySchema.parse(req.query);
    
    const start = startDate ? new Date(startDate) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
    const end = endDate ? new Date(endDate) : new Date();
    
    const ordersInPeriod = await db.execute(
      sql`SELECT 
            COUNT(*)::int as count,
            COALESCE(SUM(CAST(total AS DECIMAL)), 0) as revenue
          FROM orders 
          WHERE created_at BETWEEN ${start} AND ${end}
            AND payment_status = 'paid'`
    );
    
    res.json({
      period: { start, end },
      orders: ordersInPeriod.rows?.[0]?.count || 0,
      revenue: parseFloat(ordersInPeriod.rows?.[0]?.revenue as string || '0'),
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    throw error;
  }
});

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ==========

router.get("/users", authenticateToken, requireRole("admin"), async (req, res) => {
  const users = await storage.getUsers();

  const usersWithRoles = await Promise.all(
    users.map(async (user) => {
      const roles = await storage.getUserRoles(user.id);
      return {
        ...user,
        roles: roles.map(r => r.role),
      };
    })
  );

  res.json(usersWithRoles);
});

const updateUserSchema = z.object({
  email: z.string().email().optional(),
  firstName: z.string().min(1).max(100).optional(),
  lastName: z.string().max(100).optional(),
  patronymic: z.string().max(100).optional(),
  phone: z.string().regex(/^\+?[0-9\s()-]+$/).optional(),
  isVerified: z.boolean().optional(),
  bonusBalance: z.number().min(0).optional(),
});

router.put("/users/:id", authenticateToken, requireRole("admin"), async (req, res) => {
  try {
    const data = updateUserSchema.parse(req.body);
    
    const updated = await storage.updateUser(req.params.id, data);
    
    if (!updated) {
      return res.status(404).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }
    
    logger.info('User updated by admin', {
      adminId: req.userId,
      userId: req.params.id,
      changes: data,
    });
    
    res.json(updated);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    throw error;
  }
});

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–û–õ–Ø–ú–ò ==========

const roleSchema = z.object({
  role: z.enum(["customer", "consultant", "marketer", "admin"]),
});

router.post("/users/:id/roles", authenticateToken, requireRole("admin"), async (req, res) => {
  try {
    const { role } = roleSchema.parse(req.body);
    
    const userRole = await storage.addUserRole({
      userId: req.params.id,
      role,
    });
    
    logger.info('Role assigned by admin', {
      adminId: req.userId,
      userId: req.params.id,
      role,
    });
    
    res.json(userRole);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    throw error;
  }
});

router.delete("/users/:id/roles/:role", authenticateToken, requireRole("admin"), async (req, res) => {
  await storage.removeUserRole(req.params.id, req.params.role);
  
  logger.info('Role removed by admin', {
    adminId: req.userId,
    userId: req.params.id,
    role: req.params.role,
  });
  
  res.json({ message: "–†–æ–ª—å —É–¥–∞–ª–µ–Ω–∞" });
});

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ú–û–ö–û–î–ê–ú–ò ==========

router.get("/promocodes", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const promocodes = await storage.getPromocodes();
  res.json(promocodes);
});

const createPromocodeSchema = z.object({
  code: z.string().min(3).max(50).toUpperCase(),
  type: z.enum(["single_use", "temporary", "permanent"]),
  discountPercent: z.number().min(1).max(100),
  minOrderAmount: z.number().min(0).optional(),
  maxOrderAmount: z.number().min(0).optional(),
  maxDiscountAmount: z.number().min(0).optional(),
  expiresAt: z.string().optional(),
  isActive: z.boolean().optional().default(true),
});

router.post("/promocodes", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  try {
    const data = createPromocodeSchema.parse(req.body);
    
    const promocode = await storage.createPromocode({
      ...data,
      code: data.code.toUpperCase(),
      discountPercent: data.discountPercent.toString(),
      minOrderAmount: data.minOrderAmount?.toString() || null,
      maxOrderAmount: data.maxOrderAmount?.toString() || null,
      maxDiscountAmount: data.maxDiscountAmount?.toString() || null,
      expiresAt: data.expiresAt ? new Date(data.expiresAt) : null,
    });
    
    logger.info('Promocode created', {
      adminId: req.userId,
      code: promocode.code,
    });
    
    res.json(promocode);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    throw error;
  }
});

router.put("/promocodes/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  try {
    const data = createPromocodeSchema.partial().parse(req.body);
    
    const updated = await storage.updatePromocode(req.params.id, {
      ...data,
      code: data.code?.toUpperCase(),
      discountPercent: data.discountPercent?.toString(),
      minOrderAmount: data.minOrderAmount?.toString(),
      maxOrderAmount: data.maxOrderAmount?.toString(),
      maxDiscountAmount: data.maxDiscountAmount?.toString(),
      expiresAt: data.expiresAt ? new Date(data.expiresAt) : undefined,
    });
    
    if (!updated) {
      return res.status(404).json({ message: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    }
    
    res.json(updated);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: error.errors[0].message });
    }
    throw error;
  }
});

router.delete("/promocodes/:id", authenticateToken, requireRole("admin"), async (req, res) => {
  await storage.deletePromocode(req.params.id);
  
  logger.info('Promocode deleted by admin', {
    adminId: req.userId,
    promocodeId: req.params.id,
  });
  
  res.json({ message: "–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω" });
});

export default router;
```

---

### 4.2 –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –≤ storage.ts

**–§–∞–π–ª:** `server/storage.ts`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (–±–ª–æ–∫–∏—Ä—É–µ—Ç support.routes.ts)

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ú–µ—Ç–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ `support.routes.ts`, –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ storage:

1. `getSupportConversation(userId: string)`
2. `createSupportMessageAttachment(attachment: InsertSupportMessageAttachment)`

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã:

```typescript
// server/storage.ts

// –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å IStorage
interface IStorage {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
  
  // Support
  getSupportConversation(userId: string): Promise<SupportConversation | undefined>;
  createSupportMessageAttachment(attachment: InsertSupportMessageAttachment): Promise<SupportMessageAttachment>;
}

// –í –∫–ª–∞—Å—Å DatabaseStorage
class DatabaseStorage implements IStorage {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
  
  async getSupportConversation(userId: string): Promise<SupportConversation | undefined> {
    const [conversation] = await db
      .select()
      .from(supportConversations)
      .where(eq(supportConversations.userId, userId))
      .limit(1);
    return conversation;
  }
  
  async createSupportMessageAttachment(
    attachment: InsertSupportMessageAttachment
  ): Promise<SupportMessageAttachment> {
    const [newAttachment] = await db
      .insert(supportMessageAttachments)
      .values(attachment)
      .returning();
    return newAttachment;
  }
}
```

---

## 5. –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### 5.1 Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è

**–§–∞–π–ª—ã:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// orders.routes.ts:86
const deliveryCost = 300; // Hardcoded

// routes.ts:83-86
const CONNECTION_LIMIT = 10;
const CONNECTION_WINDOW = 60 * 1000;
const MESSAGE_LIMIT = 60;
const MESSAGE_WINDOW = 60 * 1000;
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/config/business.ts
export const BUSINESS_CONFIG = {
  order: {
    defaultDeliveryCost: 300,
    freeDeliveryThreshold: 3000,
    maxBonusPercent: 70,
  },
  websocket: {
    connectionLimit: 10,
    connectionWindow: 60 * 1000,
    messageLimit: 60,
    messageWindow: 60 * 1000,
  },
  bonus: {
    initialBonus: 100,
    tierThresholds: {
      basic: { min: 0, cashbackPercent: 5 },
      silver: { min: 10000, cashbackPercent: 7 },
      gold: { min: 50000, cashbackPercent: 10 },
    },
  },
} as const;

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
import { BUSINESS_CONFIG } from '../config/business';

const deliveryCost = subtotal >= BUSINESS_CONFIG.order.freeDeliveryThreshold
  ? 0
  : BUSINESS_CONFIG.order.defaultDeliveryCost;
```

---

### 5.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–§–∞–π–ª—ã:** –í—Å–µ route —Ñ–∞–π–ª—ã  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ù–µ—Ç JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è endpoints.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
 * 
 * @route POST /api/orders
 * @access Authenticated users
 * @description –°–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑, —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã/–±–æ–Ω—É—Å—ã
 * 
 * @body {CreateOrderSchema} data - –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
 * @returns {Order} –°–æ–∑–¥–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑
 * 
 * @throws {400} VALIDATION_ERROR - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 * @throws {400} INSUFFICIENT_STOCK - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞
 * @throws {400} PROMOCODE_EXPIRED - –ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—Ç—ë–∫
 * @throws {404} PRODUCT_NOT_FOUND - –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
router.post("/", authenticateToken, orderLimiter, async (req, res, next) => {
  // ...
});
```

---

## 6. –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

**–°—Ä–æ–∫: 1-2 –¥–Ω—è**

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts**
   - [ ] –î–æ–±–∞–≤–∏—Ç—å `getSupportConversation` –≤ storage.ts
   - [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É `searchClosedConversations`
   - [ ] –î–æ–±–∞–≤–∏—Ç—å `createSupportMessageAttachment` –≤ storage.ts
   - **–§–∞–π–ª—ã:** `server/storage.ts`, `server/routes/support.routes.ts`

2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å Promocode Race Condition**
   - [ ] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤–Ω—É—Ç—Ä—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - [ ] –î–æ–±–∞–≤–∏—Ç—å pessimistic locking (`FOR UPDATE`)
   - [ ] –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
   - **–§–∞–π–ª—ã:** `server/routes/orders.routes.ts`

3. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL Injection –≤ WebSocket**
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å raw SQL –Ω–∞ Drizzle ORM
   - [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –¥–ª—è sessions table
   - **–§–∞–π–ª—ã:** `server/routes.ts`, `shared/schema.ts`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–´–°–û–ö–ò–ô (1 –Ω–µ–¥–µ–ª—è)

**–°—Ä–æ–∫: 3-5 –¥–Ω–µ–π**

4. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å Zod –≤–∞–ª–∏–¥–∞—Ü–∏—é**
   - [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã –¥–ª—è addresses
   - [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã –¥–ª—è payment-cards
   - [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤–æ –≤—Å–µ—Ö endpoints
   - **–§–∞–π–ª—ã:** `shared/schema.ts`, `server/routes/addresses.routes.ts`, `server/routes/payment-cards.routes.ts`

5. ‚úÖ **–°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è**
   - [ ] –°–æ–∑–¥–∞—Ç—å `requireOwnership` middleware
   - [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ addresses.routes.ts
   - [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ payment-cards.routes.ts
   - **–§–∞–π–ª—ã:** `server/middleware/resourceOwnership.ts`

6. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
   - [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ error –∫–ª–∞—Å—Å—ã
   - [ ] –û–±–Ω–æ–≤–∏—Ç—å errorHandler middleware
   - [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–æ –≤—Å–µ—Ö route handlers
   - **–§–∞–π–ª—ã:** `server/utils/errors.ts`, `server/middleware/errorHandler.ts`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –°–†–ï–î–ù–ò–ô (2 –Ω–µ–¥–µ–ª–∏)

**–°—Ä–æ–∫: 7-10 –¥–Ω–µ–π**

7. ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç—å admin.routes.ts**
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   - **–§–∞–π–ª—ã:** `server/routes/admin.routes.ts`

8. ‚úÖ **–í—ã–Ω–µ—Å—Ç–∏ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è**
   - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
   - [ ] –û–±–Ω–æ–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
   - **–§–∞–π–ª—ã:** `server/config/business.ts`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ù–ò–ó–ö–ò–ô (backlog)

**–°—Ä–æ–∫: –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**

9. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**
   - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints
   - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - **–§–∞–π–ª—ã:** –í—Å–µ route —Ñ–∞–π–ª—ã

10. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Swagger/OpenAPI**
    - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    - [ ] –î–æ–±–∞–≤–∏—Ç—å swagger –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    - **–§–∞–π–ª—ã:** `server/swagger.ts`

---

## 7. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 7.1 –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–¢–µ–∫—É—â–∞—è:**
```
server/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ health.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.routes.ts
‚îÇ   ‚îî‚îÄ‚îÄ ... (12 —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ routes.ts
‚îú‚îÄ‚îÄ routes.old.ts
‚îî‚îÄ‚îÄ storage.ts
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è:**
```
server/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ health.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.routes.ts
‚îÇ   ‚îî‚îÄ‚îÄ ... (12 —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts (–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ –∫–æ—Ä–Ω—è)
‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.ts
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts
‚îÇ   ‚îú‚îÄ‚îÄ csrf.ts
‚îÇ   ‚îî‚îÄ‚îÄ resourceOwnership.ts (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ order.service.ts (–Ω–æ–≤—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ promocode.service.ts (–Ω–æ–≤—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ bonus.service.ts (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îú‚îÄ‚îÄ base.repository.ts (–Ω–æ–≤—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ user.repository.ts (–Ω–æ–≤—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ product.repository.ts (–Ω–æ–≤—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ order.repository.ts (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ business.ts (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ errors.ts
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ   ‚îú‚îÄ‚îÄ sanitize.ts
‚îÇ   ‚îî‚îÄ‚îÄ securityLogger.ts
‚îú‚îÄ‚îÄ routes.ts (—Ç–æ–ª—å–∫–æ WebSocket setup)
‚îî‚îÄ‚îÄ index.ts
```

**–ß—Ç–æ —É–¥–∞–ª–∏—Ç—å:**
- `server/routes.old.ts` - –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ä–æ—É—Ç–æ–≤

---

### 7.2 Service Layer

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–º–µ—à–∞–Ω–∞ —Å HTTP handlers.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/services/order.service.ts
export class OrderService {
  async createOrder(userId: string, data: CreateOrderData): Promise<Order> {
    // –í—Å—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
  }
  
  async updateOrderStatus(orderId: string, status: string): Promise<Order> {
    // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
  }
}

// server/routes/orders.routes.ts
const orderService = new OrderService();

router.post("/", authenticateToken, orderLimiter, async (req, res, next) => {
  try {
    const data = createOrderSchema.parse(req.body);
    const order = await orderService.createOrder(req.userId!, data);
    res.json(order);
  } catch (error) {
    next(error);
  }
});
```

---

### 7.3 Repository Pattern

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `storage.ts` (950+ —Å—Ç—Ä–æ–∫).

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server/repositories/base.repository.ts
export abstract class BaseRepository<T, InsertT> {
  constructor(protected table: any) {}
  
  async findById(id: string): Promise<T | undefined> {
    // ...
  }
  
  async findAll(options?: PaginationOptions): Promise<PaginatedResponse<T>> {
    // ...
  }
}

// server/repositories/order.repository.ts
export class OrderRepository extends BaseRepository<Order, InsertOrder> {
  constructor() {
    super(orders);
  }
  
  async findByUser(userId: string): Promise<Order[]> {
    // ...
  }
}
```

---

### 7.4 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è API
- E2E —Ç–µ—Å—Ç—ã

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom
npm install -D supertest @types/supertest

# test/server/routes/orders.test.ts
describe('POST /api/orders', () => {
  it('should create order successfully', async () => {
    const response = await request(app)
      .post('/api/orders')
      .set('Cookie', sessionCookie)
      .send(orderData);
    
    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('orderNumber');
  });
  
  it('should prevent promocode double spend', async () => {
    // Test race condition fix
  });
});
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ—É—Ç–æ–≤
- WebSocket notifications
- IDOR –∑–∞—â–∏—Ç–∞ (—á–∞—Å—Ç–∏—á–Ω–æ)
- Rate limiting

**‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts (–±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø—É—Å–∫)
- Promocode race condition (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏)
- SQL injection –≤ WebSocket (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö)

**‚ùå –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª admin –ø–∞–Ω–µ–ª–∏
- Service layer
- Repository pattern
- –¢–µ—Å—Ç—ã

### –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**–¢–µ–∫—É—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** ‚ùå **–ù–ï –ì–û–¢–û–í–û**

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1-2:** ‚ö†Ô∏è **–£–°–õ–û–í–ù–û –ì–û–¢–û–í–û**

**–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ‚úÖ **–ì–û–¢–û–í–û –ö PRODUCTION**

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (1-2 –¥–Ω—è):**
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å LSP –æ—à–∏–±–∫–∏
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å promocode race condition
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL injection

2. **–í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏:**
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
   - –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –≤–ª–∞–¥–µ–Ω–∏—è
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏

3. **–í —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞:**
   - –î–æ–ø–æ–ª–Ω–∏—Ç—å admin —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ storage.ts
   - –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

4. **Backlog:**
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - Swagger
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

**–ö–æ–Ω–µ—Ü –∞–Ω–∞–ª–∏–∑–∞**

**–ê–≤—Ç–æ—Ä:** AI Code Analysis System  
**–î–∞—Ç–∞:** 29 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0
